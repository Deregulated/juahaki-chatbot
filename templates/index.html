<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Juahaki | Kenyan Law Chatbot</title>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <!-- jsPDF for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />
</head>
<body>
  <div class="chat-container">
    <header class="chat-header">
       <div class="brand">
      <!--  <img src="{{ url_for('static', filename='img/flag.png') }}" alt="Kenya Flag" class="flag"/> -->
      <h1>Juahaki</h1>
      </div>
      <div class="header-actions">
        <button id="exportPdfBtn" class="icon-btn" title="Export PDF"><i class="fa-solid fa-file-pdf"></i></button>
        <button id="clearBtn" class="icon-btn" title="Clear chat"><i class="fa-solid fa-trash"></i></button>
        <button id="settingsBtn" class="icon-btn" title="Settings"><i class="fa-solid fa-gear"></i></button>
      </div>
    </header>

    <!-- welcome 
    <div id="welcome" class="welcome-screen">
      <h2>ðŸ‘‹ Karibu!</h2>
      <p>Iâ€™m <b>Juahaki</b> â€” your civic chatbot for Kenyan law.</p>
      <button id="startChat" class="start-btn">Start Chat</button>
    </div>
    -->

    <!-- settings -->
    <div id="settingsPanel" class="settings-panel hidden">
      <h3><i class="fa-solid fa-palette"></i> Settings</h3>

      <div class="option">
        <label>Auto-summary mode</label>
        <input type="checkbox" id="autosummaryToggle"/>
        <small>Automatically add a short summary after each reply</small>
      </div>

      <div class="option">
        <label>Theme</label>
        <select id="themeSelect">
          <option value="light">Light</option>
          <option value="dark">Dark</option>
        </select>
      </div>

      <div class="option">
        <label>Chat Background</label>
        <select id="bgSelect">
          <option value="">(default)</option>
          <option value="bg1.jpg">Sky Blue</option>
          <option value="bg2.jpg">Sunset</option>
          <option value="bg3.jpg">Abstract Dark</option>
        </select>
      </div>

      <div class="option">
        <label>Font</label>
        <select id="fontSelect">
          <option value="Poppins">Poppins</option>
          <option value="Roboto">Roboto</option>
          <option value="Courier New">Courier New</option>
        </select>
      </div>

      <button id="closeSettings" class="close-btn"><i class="fa-solid fa-xmark"></i> Close</button>
    </div>

    <!-- chat -->
    <div id="chat-box" class="chat-box hidden"></div>

    <!-- typing -->
    <div id="typingIndicator" class="typing hidden"><i class="fa-solid fa-comment-dots"></i> Juahaki is typing <span class="dot"></span><span class="dot"></span><span class="dot"></span></div>

    <!-- suggestions -->
    <div id="suggestions" class="suggestions hidden"></div>

    <!-- input -->
    <div id="chatInputWrap" class="chat-input hidden">
      <input id="userInput" type="text" placeholder="Ask about Kenyan law..." />
      <button id="sendBtn"><i class="fa-solid fa-paper-plane"></i></button>
    </div>
  </div>

  <script>
    // Utilities
    const chatBox = document.getElementById("chat-box");
    const userInput = document.getElementById("userInput");
    const sendBtn = document.getElementById("sendBtn");
    const typingIndicator = document.getElementById("typingIndicator");
    const suggestionsDiv = document.getElementById("suggestions");
    const settingsBtn = document.getElementById("settingsBtn");
    const settingsPanel = document.getElementById("settingsPanel");
    const closeSettings = document.getElementById("closeSettings");
    const autosummaryToggle = document.getElementById("autosummaryToggle");
    const exportPdfBtn = document.getElementById("exportPdfBtn");
    const clearBtn = document.getElementById("clearBtn");
    const startChat = document.getElementById("startChat");
    const welcome = document.getElementById("welcome");
    const chatInputWrap = document.getElementById("chatInputWrap");

    // persist UI settings in localStorage
    function saveSetting(key, value) { localStorage.setItem(key, JSON.stringify(value)); }
    function loadSetting(key, def) { const v = localStorage.getItem(key); return v ? JSON.parse(v) : def; }

    // Restore basic UI settings
    (function restoreUI() {
      const theme = loadSetting("juahaki_theme", "light");
      document.body.dataset.theme = theme;
      document.getElementById("themeSelect").value = theme;
      const font = loadSetting("juahaki_font", "Poppins");
      document.getElementById("fontSelect").value = font;
      document.body.style.fontFamily = font;
      const bg = loadSetting("juahaki_bg", "");
      if (bg) document.body.style.backgroundImage = `url('/static/backgrounds/${bg}')`;
      document.getElementById("bgSelect").value = bg;
      const autos = loadSetting("juahaki_autosummary", false);
      autosummaryToggle.checked = autos;
    })();

    // Chat storage mirror for UI (localStorage), to keep messages on refresh
    let storedChat = JSON.parse(localStorage.getItem("juahaki_chat")) || [];

    function formatTime() {
      const now = new Date();
      let h = now.getHours();
      const m = now.getMinutes().toString().padStart(2, "0");
      let part = "in the morning";
      if (h >= 12 && h < 17) part = "in the afternoon";
      if (h >= 17) part = "in the evening";
      h = h % 12 || 12;
      return `${h}:${m} ${part}`;
    }

    function createBotControls(text) {
      // returns a small DOM fragment with speak & copy buttons
      const container = document.createElement("div");
      container.className = "msg-controls";

      const speakBtn = document.createElement("button");
      speakBtn.className = "small-btn";
      speakBtn.title = "Speak";
      speakBtn.innerHTML = '<i class="fa-solid fa-volume-high"></i>';
      speakBtn.onclick = () => speakText(text);

      const copyBtn = document.createElement("button");
      copyBtn.className = "small-btn";
      copyBtn.title = "Copy";
      copyBtn.innerHTML = '<i class="fa-solid fa-copy"></i>';
      copyBtn.onclick = () => { navigator.clipboard.writeText(stripHtml(text)); };

      container.appendChild(speakBtn);
      container.appendChild(copyBtn);
      return container;
    }

    function stripHtml(html) {
      const tmp = document.createElement("div");
      tmp.innerHTML = html;
      return tmp.textContent || tmp.innerText || "";
    }

    function appendMessage(role, text, time = formatTime(), controls = true) {
      const msg = document.createElement("div");
      msg.classList.add("message", role);
      const inner = document.createElement("div");
      inner.className = "message-body";
      inner.innerHTML = `<div class="message-text">${text}</div><div class="time">${time}</div>`;
      msg.appendChild(inner);

      if (role === "bot" && controls) {
        const ctrl = createBotControls(text);
        msg.appendChild(ctrl);
      }
      chatBox.appendChild(msg);
      chatBox.scrollTop = chatBox.scrollHeight;

      // persist
      storedChat.push({ role, text, time });
      localStorage.setItem("juahaki_chat", JSON.stringify(storedChat));
    }

    function restoreChat() {
      chatBox.innerHTML = "";
      storedChat.forEach(m => appendMessage(m.role, m.text, m.time, m.role === "bot"));
    }

    // Speak text using Web Speech API
    function speakText(text) {
      const utter = new SpeechSynthesisUtterance(stripHtml(text));
      // voice selection / language can be tuned
      utter.lang = 'en-US';
      speechSynthesis.cancel(); // stop any ongoing
      speechSynthesis.speak(utter);
    }

    // SEND message to /chat
    async function sendMessage() {
      const message = userInput.value.trim();
      if (!message) return;
      appendMessage("user", message);
      userInput.value = "";

      typingIndicator.classList.remove("hidden");
      try {
        const res = await fetch("/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message })
        });
        const data = await res.json();
        typingIndicator.classList.add("hidden");

        appendMessage("bot", data.reply || "No response");

        // show suggestions
        showSuggestions(data.suggestions || []);

        // if auto-summary is enabled, request summary and append
        if (autosummaryToggle.checked) {
          const sumRes = await fetch("/summary", { method: "POST" });
          const sumJson = await sumRes.json();
          if (sumJson.summary) appendMessage("bot", `<b>Summary:</b><br>${sumJson.summary}`, formatTime());
        }
      } catch (err) {
        typingIndicator.classList.add("hidden");
        appendMessage("bot", "âš ï¸ Network or server error. Please try again.");
      }
    }

    // Suggestions UI
    function showSuggestions(suggestions) {
      suggestionsDiv.innerHTML = "";
      if (!suggestions || suggestions.length === 0) { suggestionsDiv.classList.add("hidden"); return; }
      suggestions.forEach(s => {
        const btn = document.createElement("button");
        btn.className = "suggestion-btn";
        btn.innerText = s;
        btn.onclick = () => { userInput.value = s; sendBtn.click(); };
        suggestionsDiv.appendChild(btn);
      });
      suggestionsDiv.classList.remove("hidden");
    }

    // Export visible chat to PDF (use jsPDF)
    async function exportPdf() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: "pt", format: "letter" });
      const margin = 40;
      let y = 40;
      doc.setFontSize(14);
      doc.text("Juahaki â€” Chat Transcript", margin, y);
      doc.setFontSize(10);
      y += 20;
      storedChat.forEach(entry => {
        const role = entry.role === "user" ? "You" : "Juahaki";
        const text = stripHtml(entry.text).replace(/\s+/g, " ");
        const lines = doc.splitTextToSize(`${role}: ${text}`, 500);
        doc.text(lines, margin, y);
        y += lines.length * 12 + 6;
        if (y > 700) { doc.addPage(); y = 40; }
      });
      doc.save(`juahaki-chat-${Date.now()}.pdf`);
    }

    // Clear chat (both UI and server session)
    async function clearChat() {
      storedChat = [];
      localStorage.removeItem("juahaki_chat");
      chatBox.innerHTML = "";
      await fetch("/clear", { method: "POST" });
    }

    // Event listeners
    sendBtn.onclick = sendMessage;
    userInput.addEventListener("keypress", e => e.key === "Enter" && sendMessage());
    settingsBtn.onclick = () => settingsPanel.classList.remove("hidden");
    closeSettings.onclick = () => settingsPanel.classList.add("hidden");
    exportPdfBtn.onclick = exportPdf;
    clearBtn.onclick = clearChat;

    // UI settings controls
    document.getElementById("themeSelect").onchange = function(e) {
      document.body.dataset.theme = e.target.value;
      saveSetting("juahaki_theme", e.target.value);
    };
    document.getElementById("bgSelect").onchange = function(e) {
      const val = e.target.value;
      saveSetting("juahaki_bg", val);
      if (val) document.body.style.backgroundImage = `url('./static/backgrounds/${val}')`; else document.body.style.backgroundImage = "";
    };
    document.getElementById("fontSelect").onchange = function(e) {
      const f = e.target.value;
      document.body.style.fontFamily = f;
      saveSetting("juahaki_font", f);
    };
    autosummaryToggle.onchange = function(e) {
      saveSetting("juahaki_autosummary", e.target.checked);
    };

    // Start chat flow and restore messages
    startChat.onclick = function() {
      welcome.classList.add("hidden");
      chatBox.classList.remove("hidden");
      document.getElementById("chatInputWrap").classList.remove("hidden");
      restoreChat();
    };

    // when page loads, if chat exists restore it automatically
    window.addEventListener("load", () => {
      if (storedChat && storedChat.length > 0) {
        welcome.classList.add("hidden");
        chatBox.classList.remove("hidden");
        document.getElementById("chatInputWrap").classList.remove("hidden");
        restoreChat();
      }
    });
  </script>
</body>
</html>
